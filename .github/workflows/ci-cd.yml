name: CI/CD Pipeline - MedFlow

# D√©clencheurs du pipeline
on:
  push:
    branches:
      - main          # D√©clenche sur push vers main
      - master        # D√©clenche sur push vers master
      - develop       # D√©clenche sur push vers develop
  pull_request:
    branches:
      - main          # D√©clenche sur PR vers main
  workflow_dispatch:  # Permet de d√©clencher manuellement

# Variables globales
env:
  REGISTRY: ghcr.io  # GitHub Container Registry
  IMAGE_PREFIX: medflow
  KUBERNETES_NAMESPACE: medflow

jobs:
  # ============================================
  # JOB 1: Tests et Validation
  # ============================================
  test:
    name: Tests et Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîç Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
            dashboard/package-lock.json
      
      # Tests Backend
      - name: üß™ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: üß™ Run Backend Tests
        working-directory: ./backend
        run: |
          echo "Running backend tests..."
          # npm test  # D√©commenter quand les tests seront cr√©√©s
          echo "‚úÖ Backend tests passed (placeholder)"
        continue-on-error: true
      
      # Tests Frontend
      - name: üß™ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: üß™ Run Frontend Tests
        working-directory: ./frontend
        run: |
          echo "Running frontend tests..."
          # npm test  # D√©commenter quand les tests seront cr√©√©s
          echo "‚úÖ Frontend tests passed (placeholder)"
        continue-on-error: true
      
      # Tests Dashboard
      - name: üß™ Install Dashboard Dependencies
        working-directory: ./dashboard
        run: npm ci
      
      - name: üß™ Run Dashboard Tests
        working-directory: ./dashboard
        run: |
          echo "Running dashboard tests..."
          # npm test  # D√©commenter quand les tests seront cr√©√©s
          echo "‚úÖ Dashboard tests passed (placeholder)"
        continue-on-error: true
      
      # Linting
      - name: üîç Lint Backend
        working-directory: ./backend
        run: |
          echo "Linting backend..."
          # npm run lint  # D√©commenter si configur√©
          echo "‚úÖ Backend linting passed (placeholder)"
        continue-on-error: true
      
      - name: üîç Lint Frontend
        working-directory: ./frontend
        run: |
          echo "Linting frontend..."
          # npm run lint  # D√©commenter si configur√©
          echo "‚úÖ Frontend linting passed (placeholder)"
        continue-on-error: true

  # ============================================
  # JOB 2: Build des Images Docker
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test  # Attendre que les tests passent
    if: github.event_name != 'pull_request'  # Ne build pas sur PR
    
    strategy:
      matrix:
        component: [backend, frontend, dashboard]
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üè∑Ô∏è Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: üèóÔ∏è Build Backend Image
        if: matrix.component == 'backend'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Cache d√©sactiv√© pour simplifier (peut √™tre r√©activ√© plus tard avec docker-container driver)
      
      - name: üèóÔ∏è Build Frontend Image
        if: matrix.component == 'frontend'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || 'http://api.medflow.local/api/v1' }}
          # Cache d√©sactiv√© pour simplifier (peut √™tre r√©activ√© plus tard avec docker-container driver)
      
      - name: üèóÔ∏è Build Dashboard Image
        if: matrix.component == 'dashboard'
        uses: docker/build-push-action@v5
        with:
          context: ./dashboard
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || 'http://api.medflow.local/api/v1' }}
          # Cache d√©sactiv√© pour simplifier (peut √™tre r√©activ√© plus tard avec docker-container driver)

  # ============================================
  # JOB 3: D√©ploiement sur Kubernetes
  # ============================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build  # Attendre que les builds soient termin√©s
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîê Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: üîê Setup Minikube (pour tests locaux)
        if: env.DEPLOY_ENV == 'local'
        uses: medyag/setup-minikube@v2
        with:
          minikube-version: 'latest'
          kubernetes-version: 'latest'
          driver: 'docker'
      
      - name: üîê Configure Kubernetes Context
        run: |
          # Pour un vrai cluster, utiliser kubeconfig depuis secrets
          # echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
          # export KUBECONFIG=kubeconfig
          
          # Pour Minikube local (d√©veloppement)
          echo "‚ö†Ô∏è  Configuration Kubernetes requise"
          echo "Pour production, configurez KUBECONFIG dans les secrets GitHub"
      
      - name: üìù Update Image Tags in Manifests
        run: |
          # R√©cup√©rer le SHA du commit
          IMAGE_TAG=$(echo ${{ github.sha }} | cut -c1-7)
          
          # Mettre √† jour les tags dans les manifests
          sed -i "s|image: medflow-backend:latest|image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-backend:main-$IMAGE_TAG|g" k8s/backend-deployment.yaml
          sed -i "s|image: medflow-frontend:latest|image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-frontend:main-$IMAGE_TAG|g" k8s/frontend-deployment.yaml
          sed -i "s|image: medflow-dashboard:latest|image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-dashboard:main-$IMAGE_TAG|g" k8s/dashboard-deployment.yaml
      
      - name: ‚úÖ Apply Kubernetes Manifests
        run: |
          # Cr√©er le namespace s'il n'existe pas
          kubectl create namespace ${{ env.KUBERNETES_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # Appliquer les manifests
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secret.yaml
          kubectl apply -f k8s/mongodb-service.yaml
          kubectl apply -f k8s/mongodb-statefulset.yaml
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/backend-service.yaml
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml
          kubectl apply -f k8s/dashboard-deployment.yaml
          kubectl apply -f k8s/dashboard-service.yaml
          kubectl apply -f k8s/ingress.yaml
          kubectl apply -f k8s/backend-hpa.yaml
          kubectl apply -f k8s/frontend-hpa.yaml
      
      - name: ‚è≥ Wait for Deployment
        run: |
          kubectl rollout status deployment/backend-deployment -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/frontend-deployment -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
          kubectl rollout status deployment/dashboard-deployment -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m
      
      - name: ‚úÖ Verify Deployment
        run: |
          echo "üìä Deployment Status:"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl get svc -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl get ingress -n ${{ env.KUBERNETES_NAMESPACE }}
          
          echo "‚úÖ Deployment successful!"

  # ============================================
  # JOB 4: Health Check Post-D√©ploiement
  # ============================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üè• Check Backend Health
        run: |
          echo "Checking backend health endpoint..."
          # curl -f http://api.medflow.local/api/v1/health || exit 1
          echo "‚úÖ Backend health check passed (placeholder)"
        continue-on-error: true
      
      - name: üè• Check Frontend
        run: |
          echo "Checking frontend availability..."
          # curl -f http://medflow.local || exit 1
          echo "‚úÖ Frontend health check passed (placeholder)"
        continue-on-error: true
      
      - name: üè• Check Dashboard
        run: |
          echo "Checking dashboard availability..."
          # curl -f http://dashboard.medflow.local || exit 1
          echo "‚úÖ Dashboard health check passed (placeholder)"
        continue-on-error: true

